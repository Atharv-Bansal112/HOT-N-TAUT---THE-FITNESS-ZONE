<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HOT N TAUT - THE FITNESS ZONE</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0f1115; --surface:#171a21; --text:#eef2f7; --muted:#9aa3af;
    --primary:#ffd54a; --primary-2:#ff9a1a; --ring:#2a2f3a;
    --ok:#22c55e; --danger:#ef4444; --shadow:0 10px 30px rgba(0,0,0,.35);
    --heading:"Inter", system-ui, Arial, sans-serif; --body:"Inter", system-ui, Arial, sans-serif; --mono:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, monospace;
  }
  .theme-neon{--bg:#07070a;--surface:#0c0f14;--text:#eaffff;--muted:#9fb0c3;--primary:#00f5ff;--primary-2:#8a2be2;--ring:#1c2230}
  .theme-midnight{--bg:#0b1020;--surface:#111a2d;--text:#e7edf8;--muted:#9bb0cc;--primary:#59aaff;--primary-2:#8bd3ff;--ring:#1a2a48}
  .theme-slate{--bg:#0e1217;--surface:#151a22;--text:#edf1f7;--muted:#a3adba;--primary:#9b87f5;--primary-2:#7c6bf0;--ring:#2a3140}
  .theme-emerald{--bg:#06120e;--surface:#0c1b16;--text:#e6f6ef;--muted:#93b5a6;--primary:#22c55e;--primary-2:#16a34a;--ring:#153c2c}
  .theme-sunset{--bg:#140c10;--surface:#1c0f15;--text:#fff4ec;--muted:#dfb7a4;--primary:#ff7a59;--primary-2:#ffae42;--ring:#3a1a1a}
  .theme-ocean{--bg:#07121a;--surface:#0d1b26;--text:#eaf6ff;--muted:#9fc0d7;--primary:#00b4d8;--primary-2:#48cae4;--ring:#153648}

  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:var(--body);-webkit-tap-highlight-color:transparent}
  h1,h2,h3{margin:0 0 8px;font-family:var(--heading)}
  p{margin:0 0 10px;color:var(--muted)}
  a{color:var(--primary);text-decoration:none}

  .container{max-width:820px;margin:0 auto;padding:20px 14px 110px}
  .card{background:var(--surface);border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
  .grid{display:grid;gap:14px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
  @media(max-width:760px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

  .input,.select,.textarea{
    width:100%;background:#0b0e13;border:1px solid var(--ring);color:var(--text);
    padding:12px;border-radius:12px;outline:none;transition:border .2s,background .2s
  }
  .input:focus,.select:focus,.textarea:focus{border-color:var(--primary);background:#0a0d12}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;width:100%;
    padding:12px 14px;border-radius:12px;border:1px solid var(--ring);
    background:linear-gradient(135deg,var(--primary),var(--primary-2));
    color:#051018;font-weight:700;cursor:pointer;transition:transform .08s,filter .2s;box-shadow:var(--shadow)
  }
  .btn:active{transform:scale(.98)}
  .btn.ghost{background:transparent;color:var(--text)}
  .btn.small{padding:8px 10px}

  .banner{position:relative;padding:18px;border-radius:16px;background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#061118;overflow:hidden}

  .intro{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:9999}
  .intro.hide{animation:fadeOut .7s ease forwards}
  .intro-logo{font-weight:800;letter-spacing:.08em;font-size:22px;padding:12px 18px;border-radius:14px;border:1px solid var(--ring);color:var(--text);box-shadow:var(--shadow);animation:popIn .6s ease}
  @keyframes popIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
  @keyframes fadeOut{to{opacity:0;visibility:hidden}}

  .topbar{position:sticky;top:0;z-index:20;backdrop-filter:blur(10px);background:linear-gradient(0deg,rgba(0,0,0,0),rgba(0,0,0,.25));padding:10px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .brand{font-weight:800;letter-spacing:.06em;color:var(--text)}
  .theme-select{width:auto;min-width:170px}

  .taskbar{position:fixed;left:0;right:0;bottom:0;z-index:50;display:flex;gap:8px;padding:10px;background:var(--surface);border-top:1px solid var(--ring)}
  .tabbtn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px 6px;gap:6px;border-radius:12px;border:1px solid var(--ring);background:#0b0f15;color:var(--text);font-size:12px;transition:background .15s,color .15s,transform .08s}
  .tabbtn .label{opacity:.95}
  .tabbtn.active{background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#061118;font-weight:700}
  .tabbtn:active{transform:translateY(1px)} .tabicon{font-size:18px}
  .view{display:none}.view.show{display:block}

  .kpi{display:flex;align-items:center;justify-content:space-between;padding:14px;border-radius:14px;border:1px solid var(--ring);background:#0b0e13}
  .kpi .big{font-size:24px;font-weight:800;font-family:var(--mono)}

  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid var(--ring)}
  th{text-align:left;color:var(--muted)}

  /* typing area (name + quotes) */
  .typewrap{display:flex;flex-direction:column;gap:6px}
  .type-line{font-weight:800;font-size:20px;white-space:nowrap;overflow:hidden;border-right:2px solid var(--text)}
  .type-sub{font-size:14px;color:var(--text)}
</style>
</head>

<body class="theme-midnight">
  <!-- Intro -->
  <div id="intro" class="intro"><div class="intro-logo">HOT N TAUT ‚Äî THE FITNESS ZONE</div></div>

  <!-- Topbar -->
  <div class="topbar">
    <div class="brand">HOT N TAUT ‚Äî THE FITNESS ZONE</div>
    <select id="themeSelect" class="select theme-select" aria-label="Theme">
      <option value="theme-midnight">Midnight (default)</option>
      <option value="theme-neon">Neon</option>
      <option value="theme-slate">Slate</option>
      <option value="theme-emerald">Emerald</option>
      <option value="theme-sunset">Sunset</option>
      <option value="theme-ocean">Ocean</option>
      <option value="">Classic</option>
    </select>
  </div>

  <!-- ===== Auth Views ===== -->
  <div id="loginView" class="container view show">
    <div class="grid">
      <div class="card">
        <h2>Member Login</h2>
        <div class="typewrap" style="margin:8px 0 6px">
          <div id="typingName" class="type-line"></div>
          <div id="typingQuote" class="type-line type-sub"></div>
        </div>
        <input id="loginEmail" class="input" type="email" placeholder="Email">
        <input id="loginPassword" class="input" type="password" placeholder="Password">
        <button class="btn" id="btnLogin">Login</button>
        <div class="grid cols-2" style="margin-top:6px">
          <button class="btn ghost" id="toSignup">Create account</button>
          <button class="btn ghost" id="toForgot">Forgot password</button>
        </div>
        <div style="margin-top:8px">
          <button class="btn ghost" id="toAdminLogin">‚öôÔ∏è Admin login</button>
        </div>
      </div>
    </div>
  </div>

  <div id="signupView" class="container view">
    <div class="card">
      <h2>Create Account</h2>
      <div class="grid cols-2">
        <input id="signupName" class="input" type="text" placeholder="Full name">
        <input id="signupEmail" class="input" type="email" placeholder="Email">
      </div>
      <div class="grid cols-2">
        <input id="signupPassword" class="input" type="password" placeholder="Password">
        <input id="signupCode" class="input" type="text" placeholder="Member code">
      </div>
      <button class="btn" id="btnSignup">Sign Up</button>
      <div style="margin-top:8px"><button class="btn ghost" id="backToLogin1">Back to login</button></div>
    </div>
  </div>

  <div id="forgotView" class="container view">
    <div class="card">
      <h2>Reset Password</h2>
      <input id="fpEmail" class="input" type="email" placeholder="Email">
      <input id="fpCode" class="input" type="text" placeholder="Member code">
      <input id="fpNewPass" class="input" type="password" placeholder="New password">
      <button class="btn" id="btnReset">Reset</button>
      <div style="margin-top:8px"><button class="btn ghost" id="backToLogin2">Back to login</button></div>
    </div>
  </div>

  <div id="adminLoginView" class="container view">
    <div class="card">
      <h2>Admin Login</h2>
      <input id="adminUser" class="input" type="text" placeholder="Admin username">
      <input id="adminPass" class="input" type="password" placeholder="Admin password">
      <button class="btn" id="btnAdminLogin">Login as Admin</button>
      <div style="margin-top:8px"><button class="btn ghost" id="backToLogin3">Back to member login</button></div>
    </div>
  </div>

  <!-- ===== User App ===== -->
  <div id="userApp" class="container view">
    <div class="banner">
      <h2 id="welcomeRotating" style="font-weight:800"></h2>
      <p id="welcomeQuote" style="color:#061118;font-weight:600"></p>
    </div>

    <!-- Dashboard -->
    <div id="dashboardTab" class="view show">
      <div class="grid cols-2">
        <div class="card kpi"><div><div style="font-weight:700">Steps Today</div><p>Keep moving.</p></div><div class="big" id="stepsToday">0</div></div>
        <div class="card kpi"><div><div style="font-weight:700">Calories Burned</div><p id="calBlurb">Estimated</p></div><div class="big" id="caloriesToday">0</div></div>
        <div class="card kpi"><div><div style="font-weight:700">Workout Time</div><p>Today</p></div><div class="big" id="timeToday">0</div></div>
        <div class="card kpi"><div><div style="font-weight:700">Active Streak</div><p>Days</p></div><div class="big" id="streakDays">0</div></div>
      </div>
    </div>

    <!-- Strength -->
    <div id="strengthTab" class="view">
      <div class="card">
        <h2>Strength</h2>
        <p>Start a template or add your own exercises.</p>
        <div class="grid cols-3" id="strengthTemplates">
          <!-- Preloaded templates -->
          <div class="card">
            <h3>Push</h3>
            <ul>
              <li>Barbell Bench ‚Äî 4√ó6‚Äì8</li>
              <li>Incline DB Press ‚Äî 3√ó8‚Äì10</li>
              <li>Overhead Press ‚Äî 3√ó6‚Äì8</li>
              <li>Lateral Raise ‚Äî 3√ó12‚Äì15</li>
              <li>Triceps Pushdown ‚Äî 3√ó10‚Äì12</li>
            </ul>
            <button class="btn small" onclick="startStrength('Push')">Start Push</button>
          </div>
          <div class="card">
            <h3>Pull</h3>
            <ul>
              <li>Deadlift ‚Äî 3√ó3‚Äì5</li>
              <li>Lat Pulldown ‚Äî 4√ó8‚Äì10</li>
              <li>Seated Row ‚Äî 3√ó8‚Äì10</li>
              <li>Face Pull ‚Äî 3√ó12‚Äì15</li>
              <li>DB Curl ‚Äî 3√ó10‚Äì12</li>
            </ul>
            <button class="btn small" onclick="startStrength('Pull')">Start Pull</button>
          </div>
          <div class="card">
            <h3>Legs</h3>
            <ul>
              <li>Back Squat ‚Äî 5√ó5</li>
              <li>Leg Press ‚Äî 3√ó10‚Äì12</li>
              <li>Romanian DL ‚Äî 3√ó6‚Äì8</li>
              <li>Leg Curl ‚Äî 3√ó10‚Äì12</li>
              <li>Calf Raise ‚Äî 4√ó12‚Äì15</li>
            </ul>
            <button class="btn small" onclick="startStrength('Legs')">Start Legs</button>
          </div>
        </div>

        <!-- Admin-prescribed workout plan appears here -->
        <div class="card" style="margin-top:10px">
          <h3>Coach Plan</h3>
          <p id="coachPlanNote">Your coach (admin) can assign workouts. They‚Äôll appear below.</p>
          <div id="coachPlan"></div>
        </div>

        <!-- User custom exercise -->
        <div class="card" style="margin-top:10px">
          <h3>Add Your Exercise</h3>
          <div class="grid cols-3">
            <input id="uxName" class="input" placeholder="Exercise name">
            <input id="uxSets" class="input" type="number" placeholder="Sets">
            <input id="uxReps" class="input" type="text" placeholder="Reps e.g. 8-10">
          </div>
          <button class="btn small" onclick="addUserExercise()">Add to My Library</button>
          <div id="userExercises" style="margin-top:8px"></div>
        </div>

        <div id="strengthActive" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- Cardio / Tracker -->
    <div id="cardioTab" class="view">
      <div class="card">
        <h2>Cardio & Step Tracker</h2>
        <div class="grid cols-2">
          <div class="card">
            <h3>Step Tracker</h3>
            <p id="sensorStatus">Sensor: not started</p>
            <div class="grid cols-3">
              <button class="btn small" onclick="initPedometer()">Enable Sensor</button>
              <button class="btn small" onclick="startStepCounter()">Start</button>
              <button class="btn small ghost" onclick="stopStepCounter()">Stop</button>
            </div>
            <div style="margin-top:8px">
              <label>Sensitivity</label>
              <input id="stepSensitivity" class="input" type="range" min="0.8" max="3" step="0.1" value="1.4" oninput="updateSensitivity(this.value)">
            </div>
            <div class="kpi" style="margin-top:10px"><div>Steps</div><div class="big" id="stepCount">0</div></div>
            <canvas id="stepsChart" height="170" style="margin-top:12px"></canvas>
          </div>
          <div class="card">
            <h3>Cardio Workouts</h3>
            <div class="grid cols-3">
              <button class="btn small" onclick="startCardio('Treadmill')">Treadmill</button>
              <button class="btn small" onclick="startCardio('Cycling')">Cycling</button>
              <button class="btn small" onclick="startCardio('Cross Trainer')">Cross Trainer</button>
            </div>
            <div style="margin-top:6px"><button class="btn small ghost" onclick="stopCardio()">Finish</button></div>
            <div id="activeWorkout" style="margin-top:8px"></div>
            <table id="cardioTable" style="margin-top:10px">
              <thead><tr><th>When</th><th>Type</th><th>Duration</th><th>Kcal</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Meals -->
    <div id="mealsTab" class="view">
      <div class="card">
        <h2>Meals (Weekly)</h2>
        <p>Your coach updates this. It refreshes live.</p>
        <div id="dietPlan"></div>
      </div>
    </div>

    <!-- Progress -->
    <div id="progressTab" class="view">
      <div class="card">
        <h2>Progress</h2>
        <div class="grid cols-2">
          <div class="card">
            <h3>Add Body Measurements</h3>
            <div class="grid cols-2">
              <input id="mWeight" class="input" type="number" step="0.1" placeholder="Weight (kg)">
              <input id="mBF" class="input" type="number" step="0.1" placeholder="Body Fat %">
              <input id="mChest" class="input" type="number" step="0.1" placeholder="Chest (cm)">
              <input id="mWaist" class="input" type="number" step="0.1" placeholder="Waist (cm)">
            </div>
            <button class="btn small" onclick="addMeasurement()">Add Measurement</button>
            <table id="measureTable" style="margin-top:10px">
              <thead><tr><th>Date</th><th>W (kg)</th><th>BF%</th><th>Chest</th><th>Waist</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="card">
            <h3>Measurements Graph</h3>
            <canvas id="measureChart" height="210"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile -->
    <div id="profileTab" class="view">
      <div class="card">
        <h2>Profile</h2>
        <div id="profileInfo"></div>
        <div style="margin-top:8px"><button class="btn ghost" onclick="logout()">Logout</button></div>
      </div>
    </div>
  </div>

  <!-- ===== Admin Panel ===== -->
  <div id="adminPanel" class="container view">
    <div class="banner">
      <h2>Admin Panel</h2>
      <p>Manage members, diet plans, workouts</p>
    </div>

    <div class="card">
      <h3>Generate Member Code</h3>
      <div class="grid cols-3">
        <input id="memberNameInput" class="input" type="text" placeholder="Member Name">
        <button class="btn small" id="btnGenCode">Generate Code</button>
        <button class="btn small ghost" id="btnAdminLogout">Logout</button>
      </div>
      <div class="grid cols-3" style="margin-top:8px">
        <input id="generatedCode" class="input" type="text" readonly placeholder="Code will appear here">
        <button class="btn small" id="btnCopyCode">Copy</button>
        <div></div>
      </div>
      <p id="lastCode" style="margin-top:6px"></p>
    </div>

    <div class="card">
      <h3>All Members</h3>
      <div id="membersList"></div>
    </div>

    <div class="card" id="editMemberCard" style="display:none;">
      <h3 id="editMemberTitle">Edit Member</h3>
      <div class="grid cols-2">
        <!-- Weekly diet plan -->
        <div class="card">
          <h4>Diet (Weekly: Morning / Afternoon / Evening)</h4>
          <div id="dietWeek" class="grid">
            <!-- generated by JS for Mon..Sun -->
          </div>
          <button class="btn small" id="btnSaveDiet">Save Diet</button>
        </div>
        <!-- Workout plan -->
        <div class="card">
          <h4>Workout Plan (Coach)</h4>
          <textarea id="workoutPlanInput" class="textarea" rows="8" placeholder="e.g. Mon: Push\nTue: Pull\nWed: Legs"></textarea>
          <button class="btn small" id="btnSaveWorkoutPlan">Save Workout Plan</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <h4>Recent Sessions</h4>
        <table id="adminSessionsTable">
          <thead><tr><th>When</th><th>Type</th><th>Dur</th><th>Kcal</th></tr></thead><tbody></tbody>
        </table>
        <h4 style="margin-top:10px">Measurements</h4>
        <table id="adminMeasuresTable">
          <thead><tr><th>Date</th><th>W</th><th>BF%</th><th>Chest</th><th>Waist</th></tr></thead><tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== Taskbar ===== -->
  <nav id="taskbar" class="taskbar" style="display:none">
    <button class="tabbtn active" data-tab="dashboard"><span class="tabicon">üè†</span><span class="label">Dashboard</span></button>
    <button class="tabbtn" data-tab="strength"><span class="tabicon">üí™</span><span class="label">Strength</span></button>
    <button class="tabbtn" data-tab="cardio"><span class="tabicon">üèÉ</span><span class="label">Cardio</span></button>
    <button class="tabbtn" data-tab="meals"><span class="tabicon">üçé</span><span class="label">Meals</span></button>
    <button class="tabbtn" data-tab="progress"><span class="tabicon">üìà</span><span class="label">Progress</span></button>
    <button class="tabbtn" data-tab="profile"><span class="tabicon">üë§</span><span class="label">Profile</span></button>
  </nav>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
/* ===========================
   FIREBASE
=========================== */
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, addDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// üîß REPLACE WITH YOUR FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyDIxW0xkJSdRduI8Z2k0z5TpCx8WvQDmNI",
  authDomain: "hot-n-taut---the-fitness-zone.firebaseapp.com",
  projectId: "hot-n-taut---the-fitness-zone",
  storageBucket: "hot-n-taut---the-fitness-zone.firebasestorage.app",
  messagingSenderId: "251132245367",
  appId: "1:251132245367:web:82ed29aa2d214ccf88dd72",
  measurementId: "G-0H86K80WD8"
};
const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===========================
   UTIL + THEME + NAV
=========================== */
const $ = (id)=>document.getElementById(id);
const views = ["loginView","signupView","forgotView","adminLoginView","userApp","adminPanel"];
function show(id){
  views.forEach(v=>$(v)?.classList.remove("show")); $(id)?.classList.add("show");
  if(id==="userApp"){ $("taskbar").style.display="flex"; switchTab("dashboard"); }
  else { $("taskbar").style.display="none"; }
}
function switchTab(tab){
  ["dashboard","strength","cardio","meals","progress","profile"].forEach(t=>$(t+"Tab")?.classList.remove("show"));
  $(tab+"Tab")?.classList.add("show");
  document.querySelectorAll(".tabbtn").forEach(b=> b.classList.toggle("active", b.dataset.tab===tab));
}
document.querySelectorAll(".tabbtn").forEach(b=> b.addEventListener("click", ()=> switchTab(b.dataset.tab)));

const themeSelect = $("themeSelect");
function applyTheme(val){ document.body.className = val || ""; }
themeSelect.addEventListener("change",(e)=>applyTheme(e.target.value));
(function bootTheme(){ const saved = localStorage.getItem("hnt_theme") || "theme-midnight"; themeSelect.value = saved; applyTheme(saved); })();
themeSelect.addEventListener("change", ()=> localStorage.setItem("hnt_theme", themeSelect.value));

/* Intro hide after mount */
window.addEventListener("load", ()=> setTimeout(()=>$("intro").classList.add("hide"), 900));

/* ===========================
   TYPING / ROTATING NAME + QUOTES
=========================== */
const quoteList = [
  "Stay consistent ‚Äî progress stacks.",
  "Form first. Weight later.",
  "Small wins, big changes.",
  "Discipline beats motivation.",
  "Recovery fuels growth."
];
let typeTimer = null;
function typeWriter(el, text, speed=40){
  return new Promise(res=>{
    el.textContent = "";
    let i=0;
    clearInterval(typeTimer);
    typeTimer = setInterval(()=>{
      el.textContent += text.charAt(i++);
      if(i>=text.length){ clearInterval(typeTimer); res(); }
    }, speed);
  });
}
async function playLoginTyping(){
  const nameEl = $("typingName");
  const quoteEl = $("typingQuote");
  const demoName = "Welcome to HOT N TAUT";
  while($("loginView").classList.contains("show")){
    await typeWriter(nameEl, demoName, 28);
    const q = quoteList[Math.floor(Math.random()*quoteList.length)];
    await typeWriter(quoteEl, q, 22);
    await new Promise(r=>setTimeout(r, 900));
    // erase
    nameEl.textContent=""; quoteEl.textContent="";
  }
}
async function setWelcomeForUser(name){
  const el = $("welcomeRotating");
  const sub = $("welcomeQuote");
  let idx=0;
  async function loop(){
    if(!$("userApp").classList.contains("show")) return;
    el.textContent = "";
    await typeWriter(el, `Welcome, ${name}`, 26);
    const q = quoteList[idx++ % quoteList.length];
    sub.textContent = "";
    await typeWriter(sub, q, 20);
    setTimeout(loop, 1400);
  }
  loop();
}

/* ===========================
   SESSION (Email only in memory)
=========================== */
let currentEmail = null; // keeps user logged-in until logout

/* ===========================
   AUTH (users collection)
=========================== */
const ADMIN_USER = "admin";
const ADMIN_PASS = "admin123";

$("toSignup").onclick = ()=> show("signupView");
$("toForgot").onclick = ()=> show("forgotView");
$("toAdminLogin").onclick = ()=> show("adminLoginView");
$("backToLogin1").onclick = $("backToLogin2").onclick = $("backToLogin3").onclick = ()=> show("loginView");

$("btnSignup").onclick = async ()=>{
  const name = $("signupName").value.trim();
  const email = $("signupEmail").value.trim().toLowerCase();
  const pass = $("signupPassword").value.trim();
  const code = $("signupCode").value.trim().toUpperCase();
  if(!name||!email||!pass||!code) return alert("Fill all fields");

  const codedoc = await getDoc(doc(db,"codes",code));
  if(!codedoc.exists()) return alert("Invalid member code");

  const udoc = await getDoc(doc(db,"users",email));
  if(udoc.exists()) return alert("Email already registered");

  const user = {
    name, email, pass,
    joinDate: "", // admin can set true joining date later
    streakStart: "", // for streak logic if needed later
    workouts: [], // user library
    theme: themeSelect.value || "theme-midnight"
  };
  await setDoc(doc(db,"users",email), user);
  alert("Account created! Please login.");
  show("loginView");
};

$("btnLogin").onclick = async ()=>{
  const email = $("loginEmail").value.trim().toLowerCase();
  const pass  = $("loginPassword").value.trim();
  if(!email||!pass) return alert("Enter email and password");

  const d = await getDoc(doc(db,"users",email));
  if(!d.exists()) return alert("No account found");
  const u = d.data();
  if(u.pass !== pass) return alert("Wrong password");

  currentEmail = email;
  applyTheme(u.theme || "theme-midnight");
  themeSelect.value = u.theme || "theme-midnight";
  await enterUserApp(u);
  $("loginEmail").value = ""; $("loginPassword").value = "";
};

$("btnReset").onclick = async ()=>{
  const email = $("fpEmail").value.trim().toLowerCase();
  const code  = $("fpCode").value.trim().toUpperCase();
  const newPass = $("fpNewPass").value.trim();
  if(!email||!code||!newPass) return alert("Fill all fields");

  const u = await getDoc(doc(db,"users",email));
  if(!u.exists()) return alert("No user found");
  const cd = await getDoc(doc(db,"codes",code));
  if(!cd.exists()) return alert("Invalid code");

  await updateDoc(doc(db,"users",email), { pass: newPass });
  alert("Password reset successful");
  show("loginView");
};

$("btnAdminLogin").onclick = async ()=>{
  const u = $("adminUser").value.trim();
  const p = $("adminPass").value.trim();
  if(u===ADMIN_USER && p===ADMIN_PASS){
    $("adminUser").value = ""; $("adminPass").value = "";
    show("adminPanel");
    renderMembers();
    buildDietWeekEditor();
  } else alert("Wrong admin credentials");
};
$("btnAdminLogout").onclick = ()=>{ show("loginView"); };

/* ===========================
   ENTER USER APP
=========================== */
async function enterUserApp(user){
  show("userApp");
  setWelcomeForUser(user.name||"Athlete");
  loadProfile(user);
  hydrateDashboard();
  initStepsChart();
  loadStepsThisWeek();
  loadDietLive();
  loadCoachPlanLive();
  loadCardioSessions();
  loadUserExercises();
}

/* ===========================
   DASHBOARD + STREAK
=========================== */
async function hydrateDashboard(){
  if(!currentEmail) return;
  const todayRef = doc(db,"users",currentEmail,"dailySteps",todayKey());
  const snap = await getDoc(todayRef);
  const stepsToday = snap.exists()? (snap.data().steps||0) : 0;
  setText("stepsToday", stepsToday);
  setText("caloriesToday", Math.round(stepsToday*0.04)); // display number only
  setText("timeToday", Math.round(stepsToday/110)); // minutes

  // streak: count consecutive days with steps > 0 ending today
  let streak = 0;
  for(let i=0;i<30;i++){
    const d = dateOffset(-i);
    const s = await getDoc(doc(db,"users",currentEmail,"dailySteps",keyOf(d)));
    const v = s.exists()? (s.data().steps||0) : 0;
    if(v>0) streak++; else break;
  }
  setText("streakDays", streak);
}
function setText(id, val){ const el=$(id); if(el) el.textContent = String(val); }

/* ===========================
   PROFILE
=========================== */
async function loadProfile(u){
  const user = u || (await (await getDoc(doc(db,"users",currentEmail))).data());
  const html = `
    <div><b>Name:</b> ${user.name||"-"}</div>
    <div><b>Email:</b> ${user.email||currentEmail}</div>
    <div><b>Date of Joining:</b> ${user.joinDate||"‚Äî (to be set by admin)"}</div>
  `;
  $("profileInfo").innerHTML = html;
}
async function logout(){
  currentEmail = null;
  show("loginView");
}

/* ===========================
   STRENGTH (templates + user library + coach plan)
=========================== */
function startStrength(block){
  $("strengthActive").innerHTML = `
    <div class="card">
      <h3>Active: ${block}</h3>
      <p>Track sets & reps as you go.</p>
      <button class="btn small" onclick="finishStrength('${block}')">Finish Session</button>
    </div>
  `;
}
async function finishStrength(block){
  if(!currentEmail) return;
  await addDoc(collection(db,"users",currentEmail,"sessions"),{
    type:`Strength - ${block}`, durationSec: 1800, kcal: 200,
    createdAt: serverTimestamp(), endedAt:new Date().toISOString()
  });
  $("strengthActive").innerHTML = "";
  alert("Strength session saved.");
  hydrateDashboard();
}
async function addUserExercise(){
  if(!currentEmail) return;
  const name = $("uxName").value.trim();
  const sets = Number($("uxSets").value||0);
  const reps = $("uxReps").value.trim();
  if(!name||!sets||!reps) return alert("Fill exercise, sets, reps.");
  const ref = doc(db,"users",currentEmail);
  const u = await getDoc(ref);
  const arr = (u.data().workouts||[]);
  arr.push({name,sets,reps});
  await updateDoc(ref,{workouts:arr});
  $("uxName").value="";$("uxSets").value="";$("uxReps").value="";
  loadUserExercises();
}
async function loadUserExercises(){
  if(!currentEmail) return;
  const u = await getDoc(doc(db,"users",currentEmail));
  const arr = (u.exists()? (u.data().workouts||[]) : []);
  $("userExercises").innerHTML = arr.length? (
    "<ul>"+arr.map(x=>`<li>${x.name} ‚Äî ${x.sets}√ó${x.reps}</li>`).join("")+"</ul>"
  ) : "<p>No custom exercises yet.</p>";
}
/* Coach plan (admin -> user) live */
let coachPlanUnsub=null;
function loadCoachPlanLive(){
  if(coachPlanUnsub) coachPlanUnsub();
  if(!currentEmail) return;
  coachPlanUnsub = onSnapshot(doc(db,"users",currentEmail), (snap)=>{
    if(!snap.exists()) return;
    const plan = snap.data().coachPlan || "";
    $("coachPlan").innerText = plan || "No plan yet.";
  });
}

/* ===========================
   MEALS (weekly) live
=========================== */
let dietUnsub=null;
function loadDietLive(){
  if(dietUnsub) dietUnsub();
  if(!currentEmail) return;
  dietUnsub = onSnapshot(doc(db,"users",currentEmail), (snap)=>{
    if(!snap.exists()) return;
    const diet = snap.data().dietWeek || {};
    $("dietPlan").innerHTML = renderDietWeek(diet);
  });
}
function renderDietWeek(weekObj){
  const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  return `
    <table>
      <thead><tr><th>Day</th><th>Morning</th><th>Afternoon</th><th>Evening</th></tr></thead>
      <tbody>
        ${days.map(d=>{
          const v = weekObj[d]||{};
          return `<tr><td>${d}</td><td>${v.morning||"-"}</td><td>${v.afternoon||"-"}</td><td>${v.evening||"-"}</td></tr>`;
        }).join("")}
      </tbody>
    </table>
  `;
}

/* ===========================
   CARDIO + SESSIONS TABLE
=========================== */
let cardioStart=null, cardioType=null;
function startCardio(type){
  cardioStart = new Date(); cardioType = type;
  $("activeWorkout").innerHTML = `<p>Active: <b>${type}</b> (tracking...)</p>`;
}
async function stopCardio(){
  if(!currentEmail || !cardioStart || !cardioType) return;
  const dur = Math.max(1, Math.floor((new Date()-cardioStart)/1000));
  const kcal = Math.round(dur/60 * (cardioType==="Cycling" ? 7 : cardioType==="Cross Trainer" ? 8 : 6));
  await addDoc(collection(db,"users",currentEmail,"sessions"),{
    type: cardioType, durationSec: dur, kcal,
    startedAt: cardioStart.toISOString(), endedAt: new Date().toISOString(),
    createdAt: serverTimestamp()
  });
  $("activeWorkout").innerHTML = "";
  cardioStart = null; cardioType = null;
  loadCardioSessions();
  hydrateDashboard();
}
async function loadCardioSessions(){
  if(!currentEmail) return;
  const snap = await getDocs(collection(db,"users",currentEmail,"sessions"));
  const rows = [];
  snap.forEach(d=>{
    const s=d.data();
    rows.push(`<tr><td>${(s.startedAt||"").slice(0,16).replace("T"," ")}</td><td>${s.type}</td><td>${Math.round((s.durationSec||0)/60)}m</td><td>${s.kcal||0}</td></tr>`);
  });
  $("cardioTable").querySelector("tbody").innerHTML = rows.reverse().join("");
}

/* ===========================
   STEPS TRACKER (DeviceMotion)
=========================== */
let stepsChart, stepData=[0,0,0,0,0,0,0];
let stepCount=0, stepTimer=null, motionOn=false, lastAccel=0, sensitivity=1.4;
function updateSensitivity(v){ sensitivity = Number(v||1.4); }
async function initPedometer(){
  try{
    if(typeof DeviceMotionEvent!=="undefined" && typeof DeviceMotionEvent.requestPermission==="function"){
      const perm = await DeviceMotionEvent.requestPermission();
      if(perm!=="granted"){ $("sensorStatus").textContent="Sensor: permission denied"; return; }
    }
    window.addEventListener("devicemotion", motionHandler);
    motionOn = true;
    $("sensorStatus").textContent="Sensor: enabled";
  }catch(e){
    $("sensorStatus").textContent="Sensor: not available";
  }
}
function motionHandler(e){
  if(!motionOn) return;
  const a = e.accelerationIncludingGravity;
  if(!a) return;
  const mag = Math.sqrt((a.x||0)**2 + (a.y||0)**2 + (a.z||0)**2);
  const peak = Math.abs(mag - lastAccel);
  lastAccel = mag;
  if(peak > sensitivity){ registerStep(); }
}
function startStepCounter(){
  if(stepTimer) return;
  // Fallback timer (for desktops) ‚Äî counts only if sensor not active
  stepTimer = setInterval(()=>{ if(!motionOn) registerStep(); }, 1200);
}
async function stopStepCounter(){
  clearInterval(stepTimer); stepTimer=null;
  await persistTodaySteps();
  hydrateDashboard();
  loadStepsThisWeek();
}
function registerStep(){
  stepCount++;
  setText("stepCount", stepCount);
  setText("stepsToday", stepCount);
  updateStepsChartPoint();
}
async function persistTodaySteps(){
  if(!currentEmail) return;
  const ref = doc(db,"users",currentEmail,"dailySteps",todayKey());
  const snap = await getDoc(ref);
  const prev = snap.exists()? (snap.data().steps||0) : 0;
  await setDoc(ref,{ steps: Math.max(prev, stepCount), updatedAt: serverTimestamp() });
}
function initStepsChart(){
  const ctx = $("stepsChart").getContext("2d");
  stepsChart?.destroy?.();
  stepsChart = new Chart(ctx,{
    type:"line",
    data:{
      labels:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],
      datasets:[
        {label:"Steps", data:[0,0,0,0,0,0,0], borderWidth:2, pointRadius:2}
      ]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{y:{ticks:{color: getComputedStyle(document.body).getPropertyValue('--text')}}}
    }
  });
}
function weekdayIndex(d){ return (d.getDay()+6)%7; } // Mon=0..Sun=6
function updateStepsChartPoint(){
  if(!stepsChart) return;
  const idx = weekdayIndex(new Date());
  stepsChart.data.datasets[0].data[idx] = stepCount;
  stepsChart.update();
}
async function loadStepsThisWeek(){
  if(!currentEmail || !stepsChart) return;
  const arr = [0,0,0,0,0,0,0];
  const now = new Date();
  for(let i=0;i<7;i++){
    const d = new Date(now); d.setDate(now.getDate() - ((6 - i)));
    const snap = await getDoc(doc(db,"users",currentEmail,"dailySteps",keyOf(d)));
    arr[i] = snap.exists()? (snap.data().steps||0) : 0;
  }
  stepsChart.data.datasets[0].data = arr;
  stepsChart.update();
  const t = arr[weekdayIndex(new Date())];
  stepCount = t;
  setText("stepCount", t);
  setText("stepsToday", t);
}

/* ===========================
   PROGRESS (measurements)
=========================== */
let measureChart=null;
function initMeasureChart(){
  const ctx = $("measureChart").getContext("2d");
  measureChart?.destroy?.();
  measureChart = new Chart(ctx,{
    type:"line",
    data:{ labels:[], datasets:[
      {label:"Weight", data:[], borderWidth:2, pointRadius:2},
      {label:"Body Fat %", data:[], borderWidth:2, pointRadius:2},
      {label:"Chest", data:[], borderWidth:2, pointRadius:2},
      {label:"Waist", data:[], borderWidth:2, pointRadius:2}
    ]},
    options:{
      responsive:true,
      plugins:{legend:{labels:{color:getComputedStyle(document.body).getPropertyValue('--text')}}},
      scales:{
        x:{ticks:{color:getComputedStyle(document.body).getPropertyValue('--text')}},
        y:{ticks:{color:getComputedStyle(document.body).getPropertyValue('--text')}}
      }
    }
  });
}
async function addMeasurement(){
  if(!currentEmail) return;
  const w = parseFloat($("mWeight").value||"");
  const bf = parseFloat($("mBF").value||"");
  const ch = parseFloat($("mChest").value||"");
  const ws = parseFloat($("mWaist").value||"");
  if(!(w||bf||ch||ws)) return alert("Enter at least one measurement.");

  await addDoc(collection(db,"users",currentEmail,"measurements"),{
    date: new Date().toISOString(),
    weight: isNaN(w)? null:w,
    bf: isNaN(bf)? null:bf,
    chest: isNaN(ch)? null:ch,
    waist: isNaN(ws)? null:ws,
    createdAt: serverTimestamp()
  });

  $("mWeight").value="";$("mBF").value="";$("mChest").value="";$("mWaist").value="";
  loadMeasurements();
}
async function loadMeasurements(){
  if(!currentEmail) return;
  initMeasureChart();
  const snap = await getDocs(collection(db,"users",currentEmail,"measurements"));
  const rows=[], labels=[], w=[], bf=[], ch=[], ws=[];
  const list=[];
  snap.forEach(d=> list.push({...d.data(), _id:d.id}));
  list.sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  list.forEach(m=>{
    const dt = (m.date||"").slice(0,10);
    rows.push(`<tr><td>${dt}</td><td>${m.weight??""}</td><td>${m.bf??""}</td><td>${m.chest??""}</td><td>${m.waist??""}</td></tr>`);
    labels.push(dt);
    w.push(m.weight??null); bf.push(m.bf??null); ch.push(m.chest??null); ws.push(m.waist??null);
  });
  $("measureTable").querySelector("tbody").innerHTML = rows.reverse().join("");

  measureChart.data.labels = labels;
  measureChart.data.datasets[0].data = w;
  measureChart.data.datasets[1].data = bf;
  measureChart.data.datasets[2].data = ch;
  measureChart.data.datasets[3].data = ws;
  measureChart.update();
}

/* ===========================
   ADMIN ‚Äî members / code / editor
=========================== */
$("btnGenCode").onclick = async ()=>{
  const name = $("memberNameInput").value.trim();
  if(!name) return alert("Enter member name");
  const code = (name.split(" ")[0]||name).toUpperCase()+"-"+Math.floor(10000+Math.random()*90000);
  await setDoc(doc(db,"codes",code),{name,used:false,createdAt:serverTimestamp()});
  $("generatedCode").value = code;
  $("lastCode").textContent = "Generated code: "+code;
};
$("btnCopyCode").onclick = async ()=>{
  const c = $("generatedCode").value.trim();
  if(!c) return;
  try{ await navigator.clipboard.writeText(c); alert("Code copied"); }catch{ alert("Copy failed"); }
};

async function renderMembers(){
  const snap = await getDocs(collection(db,"users"));
  const list = [];
  snap.forEach(d=>{
    const u = d.data();
    list.push(`<div style="border:1px solid var(--ring);border-radius:12px;padding:10px;margin:8px 0;display:flex;justify-content:space-between;align-items:center;">
      <div><b>${u.name||"-"}</b> ‚Ä¢ ${u.email}<br><small>Joined: ${u.joinDate||"-"}</small></div>
      <div style="display:flex;gap:6px">
        <button class="btn small" onclick="adminEdit('${d.id}')">Manage</button>
        <button class="btn small ghost" onclick="adminSetJoin('${d.id}')">Set Join Date</button>
      </div>
    </div>`);
  });
  $("membersList").innerHTML = list.join("") || "<p>No members yet.</p>";
}
let _adminSelected = null;
window.adminEdit = async function(email){
  _adminSelected = email;
  $("editMemberCard").style.display = "block";
  const u = await getDoc(doc(db,"users",email));
  $("editMemberTitle").textContent = "Edit: "+(u.data().name||email);
  $("workoutPlanInput").value = u.data().coachPlan||"";
  buildDietWeekEditor(u.data().dietWeek||{});
  // Load tables
  const ses = await getDocs(collection(db,"users",email,"sessions"));
  const ms = await getDocs(collection(db,"users",email,"measurements"));
  const srows=[], mrows=[];
  const sList=[], mList=[];
  ses.forEach(d=> sList.push(d.data()));
  sList.sort((a,b)=> (a.startedAt||"").localeCompare(b.startedAt||""));
  sList.forEach(s=>{
    srows.push(`<tr><td>${(s.startedAt||"").slice(0,16).replace("T"," ")}</td><td>${s.type}</td><td>${Math.round((s.durationSec||0)/60)}m</td><td>${s.kcal||0}</td></tr>`);
  });
  ms.forEach(d=> mList.push(d.data()));
  mList.sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  mList.forEach(m=>{
    mrows.push(`<tr><td>${(m.date||"").slice(0,10)}</td><td>${m.weight??""}</td><td>${m.bf??""}</td><td>${m.chest??""}</td><td>${m.waist??""}</td></tr>`);
  });
  $("adminSessionsTable").querySelector("tbody").innerHTML = srows.reverse().join("");
  $("adminMeasuresTable").querySelector("tbody").innerHTML = mrows.reverse().join("");
};
window.adminSetJoin = async function(email){
  const dt = prompt("Enter join date (YYYY-MM-DD)");
  if(!dt) return;
  await updateDoc(doc(db,"users",email), { joinDate: dt });
  alert("Join date saved.");
  renderMembers();
};

function buildDietWeekEditor(existing={}){
  const cont = $("dietWeek");
  if(!cont) return;
  const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  cont.innerHTML = days.map(d=>{
    const v = existing[d]||{};
    return `
      <div class="card">
        <h4 style="margin-bottom:6px">${d}</h4>
        <input class="input" id="d_${d}_m" placeholder="Morning" value="${v.morning||""}">
        <input class="input" id="d_${d}_a" placeholder="Afternoon" value="${v.afternoon||""}">
        <input class="input" id="d_${d}_e" placeholder="Evening" value="${v.evening||""}">
      </div>
    `;
  }).join("");
}
$("btnSaveDiet").onclick = async ()=>{
  if(!_adminSelected) return;
  const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  const week={};
  days.forEach(d=>{
    week[d] = {
      morning: $("d_"+d+"_m").value.trim(),
      afternoon: $("d_"+d+"_a").value.trim(),
      evening: $("d_"+d+"_e").value.trim()
    };
  });
  await updateDoc(doc(db,"users",_adminSelected), { dietWeek: week });
  alert("Diet saved.");
};
$("btnSaveWorkoutPlan").onclick = async ()=>{
  if(!_adminSelected) return;
  await updateDoc(doc(db,"users",_adminSelected), { coachPlan: $("workoutPlanInput").value });
  alert("Workout plan saved.");
};

/* ===========================
   MEASUREMENTS LOAD ON TAB OPEN
=========================== */
document.querySelector('[data-tab="progress"]').addEventListener("click", loadMeasurements);

/* ===========================
   HELPERS: date keys
=========================== */
function todayKey(){ return keyOf(new Date()); }
function keyOf(d){
  const y=d.getFullYear(), m=("0"+(d.getMonth()+1)).slice(-2), day=("0"+d.getDate()).slice(-2);
  return `${y}-${m}-${day}`;
}
function dateOffset(n){
  const d=new Date(); d.setDate(d.getDate()+n); return d;
}

/* ===========================
   STARTUP
=========================== */
playLoginTyping();            // typing on login
initMeasureChart();           // prepare graph
</script>
</body>
</html>
