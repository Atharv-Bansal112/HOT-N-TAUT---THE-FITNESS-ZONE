<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HOT N TAUT ‚Äî THE FITNESS ZONE</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0f1115; --surface:#171a21; --text:#eef2f7; --muted:#9aa3af;
    --primary:#ffd54a; --primary-2:#ff9a1a; --ring:#2a2f3a; --ok:#22c55e; --danger:#ef4444;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius:16px; --gap:14px;
    --heading:"Inter",system-ui,Arial,sans-serif; --body:"Inter",system-ui,Arial,sans-serif; --mono:"JetBrains Mono",ui-monospace,Menlo,monospace;
  }
  /* Professional theme set; text colors adapt for readability */
  .theme-midnight { --bg:#0b1020; --surface:#111a2d; --text:#e7edf8; --muted:#9bb0cc; --primary:#59aaff; --primary-2:#8bd3ff; --ring:#1a2a48; }
  .theme-neon     { --bg:#05060a; --surface:#0b0d14; --text:#eaffff; --muted:#a7c6d1; --primary:#00f5ff; --primary-2:#8a2be2; --ring:#1b2337; }
  .theme-slate    { --bg:#0e1217; --surface:#151a22; --text:#edf1f7; --muted:#a3adba; --primary:#9b87f5; --primary-2:#7c6bf0; --ring:#2a3140; }
  .theme-emerald  { --bg:#06120e; --surface:#0c1b16; --text:#e6f6ef; --muted:#93b5a6; --primary:#22c55e; --primary-2:#16a34a; --ring:#153c2c; }
  .theme-sunset   { --bg:#140c10; --surface:#1c0f15; --text:#fff4ec; --muted:#dfb7a4; --primary:#ff7a59; --primary-2:#ffae42; --ring:#3a1a1a; }
  .theme-ocean    { --bg:#07121a; --surface:#0d1b26; --text:#eaf6ff; --muted:#9fc0d7; --primary:#00b4d8; --primary-2:#48cae4; --ring:#153648; }
  body{margin:0;background:var(--bg);color:var(--text);font-family:var(--body);-webkit-tap-highlight-color:transparent}
  h1,h2,h3{margin:0 0 8px;font-family:var(--heading)}
  p{margin:0 0 10px;color:var(--muted)}
  .container{max-width:860px;margin:0 auto;padding:20px 14px 120px}
  .card{background:var(--surface);border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
  .grid{display:grid;gap:14px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
  @media(max-width:720px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}
  .input,.select,.textarea{width:100%;background:#0a0d14;border:1px solid var(--ring);color:var(--text);padding:12px;border-radius:12px;outline:none;transition:border .2s,background .2s}
  .input:focus,.select:focus,.textarea:focus{border-color:var(--primary);background:#0a0e15}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--ring);background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#071018;font-weight:800;cursor:pointer;transition:transform .06s,filter .2s;box-shadow:var(--shadow)}
  .btn:active{transform:scale(.98)}
  .btn.ghost{background:transparent;color:var(--text)}
  .btn.warn{background:linear-gradient(135deg,#ff6b6b,#ef4444); color:#fff}
  .banner{position:relative;padding:18px;border-radius:16px;background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#061118;overflow:hidden}
  .taskbar{position:fixed;left:0;right:0;bottom:0;z-index:50;display:flex;gap:8px;padding:10px;background:var(--surface);border-top:1px solid var(--ring)}
  .tabbtn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px 6px;gap:6px;border-radius:12px;border:1px solid var(--ring);background:#0b0f15;color:var(--muted);font-size:12px;transition:background .15s,color .15s,transform .08s}
  .tabbtn.active{background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#061118;font-weight:800}
  .tabicon{font-size:18px}
  .view{display:none}.view.show{display:block}
  .topbar{position:sticky;top:0;z-index:20;backdrop-filter:blur(8px);background:linear-gradient(0deg,rgba(0,0,0,0),rgba(0,0,0,.25));padding:10px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .brand{font-weight:900;letter-spacing:.06em;color:var(--text)}
  .theme-select{width:auto;min-width:170px}
  .kpi{display:flex;align-items:center;justify-content:space-between;padding:14px;border-radius:14px;border:1px solid var(--ring);background:#0a0d14}
  .kpi .big{font-size:26px;font-weight:900;font-family:var(--mono)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid var(--ring)}
  th{text-align:left;color:var(--muted)}
  /* Intro splash (kept) */
  .intro{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:9999}
  .intro.hide{opacity:0;visibility:hidden;transition:opacity .5s ease}
  .intro-logo{font-weight:900;letter-spacing:.08em;font-size:22px;padding:12px 18px;border-radius:14px;border:1px solid var(--ring);color:var(--text);box-shadow:var(--shadow)}
  /* Animated welcome (no fading, rotating, typing) */
  .welcome-wrap{display:flex;flex-direction:column;gap:6px}
  .welcome-name{font-size:24px;font-weight:900;white-space:nowrap}
  .rotator{display:inline-block;animation:rot 6s linear infinite}
  @keyframes rot{0%{transform:rotate(0deg)}50%{transform:rotate(1deg)}100%{transform:rotate(0deg)}}
  .typing{font-weight:700; white-space:nowrap; border-right:2px solid currentColor; overflow:hidden}
</style>
</head>
<body class="theme-midnight">
  <!-- Intro (kept) -->
  <div id="intro" class="intro"><div class="intro-logo">HOT N TAUT ‚Äî THE FITNESS ZONE</div></div>

  <!-- Top bar (unchanged interface) -->
  <div class="topbar">
    <div class="brand">HOT N TAUT ‚Äî THE FITNESS ZONE</div>
    <select id="themeSelect" class="select theme-select" aria-label="Theme">
      <option value="theme-midnight">Midnight (default)</option>
      <option value="theme-neon">Neon</option>
      <option value="theme-slate">Slate</option>
      <option value="theme-emerald">Emerald</option>
      <option value="theme-sunset">Sunset</option>
      <option value="theme-ocean">Ocean</option>
      <option value="">Classic</option>
    </select>
  </div>

  <!-- ===== Auth Views (login links fixed) ===== -->
  <div id="loginView" class="container view show">
    <div class="grid">
      <div class="card">
        <h2>Member Login</h2>
        <p>Welcome back! Train hard, recover smart.</p>
        <input id="loginName" class="input" type="text" placeholder="Full Name">
        <input id="loginEmail" class="input" type="email" placeholder="Email">
        <input id="loginPassword" class="input" type="password" placeholder="Password">
        <button class="btn" id="btnLogin">Login</button>
        <div class="grid cols-2" style="margin-top:6px">
          <button class="btn ghost" id="toSignup">Create account</button>
          <button class="btn ghost" id="toForgot">Forgot password</button>
        </div>
        <div style="margin-top:8px">
          <button class="btn ghost" id="toAdminLogin">‚öôÔ∏è Admin login</button>
        </div>
      </div>
    </div>
  </div>

  <div id="signupView" class="container view">
    <div class="card">
      <h2>Sign Up</h2>
      <div class="grid cols-2">
        <input id="signupName" class="input" type="text" placeholder="Full name">
        <input id="signupEmail" class="input" type="email" placeholder="Email">
      </div>
      <div class="grid cols-2">
        <input id="signupPassword" class="input" type="password" placeholder="Password">
        <input id="signupCode" class="input" type="text" placeholder="Member code">
      </div>
      <button class="btn" id="btnSignup">Create account</button>
      <div style="margin-top:8px"><button class="btn ghost" id="backToLogin1">Back to login</button></div>
    </div>
  </div>

  <div id="forgotView" class="container view">
    <div class="card">
      <h2>Reset Password</h2>
      <input id="fpEmail" class="input" type="email" placeholder="Email">
      <input id="fpCode" class="input" type="text" placeholder="Member code">
      <input id="fpNewPass" class="input" type="password" placeholder="New password">
      <button class="btn" id="btnReset">Reset</button>
      <div style="margin-top:8px"><button class="btn ghost" id="backToLogin2">Back to login</button></div>
    </div>
  </div>

  <div id="adminLoginView" class="container view">
    <div class="card">
      <h2>Admin Login</h2>
      <input id="adminUser" class="input" type="text" placeholder="Admin username">
      <input id="adminPass" class="input" type="password" placeholder="Admin password">
      <button class="btn" id="btnAdminLogin">Login as Admin</button>
      <div style="margin-top:8px"><button class="btn ghost" id="backToLogin3">Back to member login</button></div>
    </div>
  </div>

  <!-- ===== User App ===== -->
  <div id="userApp" class="container view">
    <div class="banner">
      <div class="welcome-wrap">
        <div class="welcome-name">Welcome, <span id="welcomeName" class="rotator">Athlete</span></div>
        <div id="quoteLine" class="typing"></div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardTab" class="view show">
      <div class="grid cols-3">
        <div class="card kpi"><div><div style="font-weight:800">Steps Today</div><p>Keep moving.</p></div><div class="big" id="stepsToday">0</div></div>
        <div class="card kpi"><div><div style="font-weight:800">Calories Burned</div><p id="calBlurb">Estimated</p></div><div class="big" id="caloriesToday">0</div></div>
        <div class="card kpi"><div><div style="font-weight:800">Workout Time</div><p>Today</p></div><div class="big" id="timeToday">0</div></div>
        <div class="card kpi"><div><div style="font-weight:800">Active Streak</div><p>Consecutive days</p></div><div class="big" id="streakDays">0</div></div>
        <div class="card kpi"><div><div style="font-weight:800">Total Sessions</div><p>All-time</p></div><div class="big" id="totalSessions">0</div></div>
        <div class="card kpi"><div><div style="font-weight:800">Last Session</div><p>Type</p></div><div class="big" id="lastSessionType">‚Äî</div></div>
      </div>
    </div>

    <!-- Strength -->
    <div id="strengthTab" class="view">
      <div class="card">
        <h2>Strength</h2>
        <p>Pick a template or add your own exercises. Track sets/reps/weight; saved to history.</p>
        <div class="grid cols-3">
          <div class="card">
            <h3>Push</h3>
            <ul>
              <li>Barbell Bench ‚Äî 4√ó6‚Äì8</li>
              <li>Incline DB Press ‚Äî 3√ó8‚Äì10</li>
              <li>Overhead Press ‚Äî 3√ó6‚Äì8</li>
              <li>Lateral Raises ‚Äî 3√ó12‚Äì15</li>
              <li>Triceps Pushdown ‚Äî 3√ó10‚Äì12</li>
            </ul>
            <button class="btn" onclick="startStrength('Push')">Start Push</button>
          </div>
          <div class="card">
            <h3>Pull</h3>
            <ul>
              <li>Deadlift ‚Äî 3√ó3‚Äì5</li>
              <li>Lat Pulldown ‚Äî 4√ó8‚Äì10</li>
              <li>Seated Row ‚Äî 3√ó8‚Äì10</li>
              <li>Face Pulls ‚Äî 3√ó12‚Äì15</li>
              <li>DB Curl ‚Äî 3√ó10‚Äì12</li>
            </ul>
            <button class="btn" onclick="startStrength('Pull')">Start Pull</button>
          </div>
          <div class="card">
            <h3>Legs</h3>
            <ul>
              <li>Back Squat ‚Äî 5√ó5</li>
              <li>Leg Press ‚Äî 3√ó10‚Äì12</li>
              <li>Romanian DL ‚Äî 3√ó6‚Äì8</li>
              <li>Leg Curl ‚Äî 3√ó10‚Äì12</li>
              <li>Calf Raise ‚Äî 4√ó12‚Äì15</li>
            </ul>
            <button class="btn" onclick="startStrength('Legs')">Start Legs</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Add Custom Exercise</h3>
          <div class="grid cols-3">
            <input id="ceName" class="input" placeholder="Exercise name">
            <input id="ceTarget" class="input" placeholder="Target (e.g., Chest)">
            <button class="btn" onclick="addCustomExercise()">Add</button>
          </div>
          <div id="customExerciseList" style="margin-top:8px"></div>
        </div>

        <div id="strengthActive" style="margin-top:12px"></div>
        <div class="card" style="margin-top:12px">
          <h3>Strength History</h3>
          <table id="strengthTable"><thead><tr><th>When</th><th>Template</th><th>Notes</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <!-- Cardio & Step Tracker -->
    <div id="cardioTab" class="view">
      <div class="card">
        <h2>Cardio & Tracker</h2>
        <div class="grid cols-2">
          <div class="card">
            <h3>Step Tracker</h3>
            <p id="sensorStatus">Sensor: not started</p>
            <div class="grid cols-3">
              <button class="btn" onclick="startStepCounter()">Start</button>
              <button class="btn ghost" onclick="stopStepCounter()">Stop</button>
              <button class="btn ghost" onclick="calibrateSteps()">Calibrate</button>
            </div>
            <div class="grid cols-3" style="margin-top:6px">
              <input id="stepSensitivity" class="input" type="number" step="0.01" value="1.12" title="Sensitivity (lower = stricter)">
              <input id="stepCooldown" class="input" type="number" step="10" value="220" title="Cooldown ms">
              <button class="btn ghost" onclick="stepTap()">+1 (fallback)</button>
            </div>
            <div class="kpi" style="margin-top:10px"><div>Steps</div><div class="big" id="stepCount">0</div></div>
            <canvas id="stepsChart" height="180" style="margin-top:12px"></canvas>
          </div>
          <div class="card">
            <h3>Cardio Workouts</h3>
            <div class="grid cols-3">
              <button class="btn" onclick="startCardio('Treadmill')">Treadmill</button>
              <button class="btn" onclick="startCardio('Cycling')">Cycling</button>
              <button class="btn" onclick="startCardio('Cross Trainer')">Cross Trainer</button>
              <button class="btn ghost" onclick="stopCardio()">Finish</button>
            </div>
            <div id="activeWorkout" style="margin-top:10px"></div>
            <table id="cardioTable" style="margin-top:10px">
              <thead><tr><th>When</th><th>Type</th><th>Duration</th><th>Kcal</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Meals (weekly plan) -->
    <div id="mealsTab" class="view">
      <div class="card">
        <h2>Meals</h2>
        <p>Weekly plan assigned by admin.</p>
        <table id="mealsTable" style="margin-top:10px">
          <thead><tr><th>Day</th><th>Morning</th><th>Afternoon</th><th>Evening</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Progress -->
    <div id="progressTab" class="view">
      <div class="card">
        <h2>Progress</h2>
        <div class="grid cols-2">
          <div class="card">
            <h3>Add Measurement</h3>
            <div class="grid cols-2">
              <input id="mWeight" class="input" type="number" step="0.1" placeholder="Weight (kg)">
              <input id="mBF" class="input" type="number" step="0.1" placeholder="Body Fat %">
              <input id="mChest" class="input" type="number" step="0.1" placeholder="Chest (cm)">
              <input id="mWaist" class="input" type="number" step="0.1" placeholder="Waist (cm)">
            </div>
            <button class="btn" onclick="addMeasurement()">Add Measurement</button>
            <table id="measureTable" style="margin-top:10px">
              <thead><tr><th>Date</th><th>W (kg)</th><th>BF%</th><th>Chest</th><th>Waist</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="card">
            <h3>Measurements Graph</h3>
            <canvas id="measureChart" height="210"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile -->
    <div id="profileTab" class="view">
      <div class="card">
        <h2>Profile</h2>
        <div id="profileInfo"></div>
        <div class="grid cols-2" style="margin-top:10px">
          <select id="profileTheme" class="select">
            <option value="">Classic</option>
            <option value="theme-midnight">Midnight</option>
            <option value="theme-neon">Neon</option>
            <option value="theme-slate">Slate</option>
            <option value="theme-emerald">Emerald</option>
            <option value="theme-sunset">Sunset</option>
            <option value="theme-ocean">Ocean</option>
          </select>
          <button class="btn ghost" onclick="applyProfileTheme()">Apply Theme</button>
        </div>
        <div class="grid cols-2" style="margin-top:10px">
          <button class="btn warn" onclick="logout()">Logout</button>
          <button class="btn ghost" onclick="refreshAccount()">Refresh Account</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Admin Panel ===== -->
  <div id="adminPanel" class="container view">
    <div class="banner">
      <h2>Admin Panel</h2>
      <p>HOT N TAUT ‚Äî Manage members & plans</p>
    </div>

    <div class="card">
      <h3>Generate Member Code</h3>
      <div class="grid cols-3">
        <input id="memberNameInput" class="input" type="text" placeholder="Member Name">
        <button class="btn" id="btnGenCode">Generate Code</button>
        <button class="btn ghost" id="btnCopyCode">Copy</button>
      </div>
      <p id="lastCode" style="margin-top:6px;font-family:var(--mono)"></p>
    </div>

    <div class="card">
      <h3>All Members</h3>
      <div id="membersList"></div>
    </div>

    <div class="card" id="editMemberCard" style="display:none;">
      <h3 id="editMemberTitle">Edit Member</h3>
      <div class="grid cols-3">
        <input id="editJoinDate" class="input" type="date" placeholder="Join Date">
        <input id="editMemberCode" class="input" type="text" placeholder="Member Code">
        <button class="btn ghost" id="btnSaveMeta">Save Meta</button>
      </div>
      <h4>Diet Plan (Weekly)</h4>
      <div id="dietGrid" class="grid cols-3" style="margin-bottom:8px"></div>
      <button class="btn" id="btnSaveDiet">Save Diet Plan</button>

      <h4 style="margin-top:14px">Assign Custom Strength Exercise</h4>
      <div class="grid cols-3">
        <input id="admExName" class="input" placeholder="Exercise name">
        <input id="admExTarget" class="input" placeholder="Target">
        <button class="btn ghost" id="btnAdmAddEx">Add to Member</button>
      </div>

      <div style="margin-top:14px">
        <h4>Recent Sessions</h4>
        <table id="adminSessionsTable"><thead><tr><th>When</th><th>Type</th><th>Dur</th><th>Kcal</th></tr></thead><tbody></tbody></table>
        <h4 style="margin-top:10px">Measurements</h4>
        <table id="adminMeasuresTable"><thead><tr><th>Date</th><th>W</th><th>BF%</th><th>Chest</th><th>Waist</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div class="grid cols-2" style="margin-top:10px">
      <button class="btn ghost" id="btnAdminLogout">Logout (Admin)</button>
      <button class="btn" id="btnAdminBack">Back to Login</button>
    </div>
  </div>

  <!-- ===== Taskbar (unchanged) ===== -->
  <nav id="taskbar" class="taskbar" style="display:none">
    <button class="tabbtn active" data-tab="dashboard"><span class="tabicon">üè†</span><span class="label">Dashboard</span></button>
    <button class="tabbtn" data-tab="strength"><span class="tabicon">üí™</span><span class="label">Strength</span></button>
    <button class="tabbtn" data-tab="cardio"><span class="tabicon">üèÉ</span><span class="label">Cardio</span></button>
    <button class="tabbtn" data-tab="meals"><span class="tabicon">üçé</span><span class="label">Meals</span></button>
    <button class="tabbtn" data-tab="progress"><span class="tabicon">üìà</span><span class="label">Progress</span></button>
    <button class="tabbtn" data-tab="profile"><span class="tabicon">üë§</span><span class="label">Profile</span></button>
  </nav>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    /* ===========================
       FIREBASE BOOTSTRAP
    =========================== */
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- Admin demo creds (keep/change) ---
    const ADMIN_USER = "admin";
    const ADMIN_PASS = "admin123";

    // TODO: YOUR FIREBASE CONFIG
    const firebaseConfig = {
    apiKey: "AIzaSyDIxW0xkJSdRduI8Z2k0z5TpCx8WvQDmNI",
    authDomain: "hot-n-taut---the-fitness-zone.firebaseapp.com",
    projectId: "hot-n-taut---the-fitness-zone",
    storageBucket: "hot-n-taut---the-fitness-zone.firebasestorage.app",
    messagingSenderId: "251132245367",
    appId: "1:251132245367:web:82ed29aa2d214ccf88dd72",
    measurementId:¬†"G-0H86K80WD8"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ===========================
       UTIL + THEME + NAV
    =========================== */
    const $ = (id)=>document.getElementById(id);
    const show = (id)=>{ document.querySelectorAll(".view").forEach(v=>v.classList.remove("show")); $(id)?.classList.add("show"); };
    const showUserApp = ()=>{ show("userApp"); $("taskbar").style.display="flex"; switchTab("dashboard"); updateWelcome(); };
    const showLogin = ()=>{ show("loginView"); $("taskbar").style.display="none"; clearAuthInputs(); };
    function clearAuthInputs(){
      ["loginName","loginEmail","loginPassword","signupName","signupEmail","signupPassword","signupCode","adminUser","adminPass","fpEmail","fpCode","fpNewPass"].forEach(id=>{ const el=$(id); if(el) el.value=""; });
    }
    function updateWelcome(){
      if(!state.user) return;
      $("welcomeName").textContent = state.user.name || "Athlete";
    }
    // Intro hide
    window.addEventListener("load", ()=> setTimeout(()=>{ $("intro")?.classList.add("hide"); }, 850));

    // Theme
    const themeSelect = $("themeSelect");
    function applyTheme(val){ document.body.className = val || ""; localStorage.setItem("hnt_theme", val || ""); }
    themeSelect.addEventListener("change",(e)=>applyTheme(e.target.value));
    (function bootTheme(){ const saved = localStorage.getItem("hnt_theme") || "theme-midnight"; themeSelect.value = saved; applyTheme(saved); })();

    function switchTab(tab){
      ["dashboard","strength","cardio","meals","progress","profile"].forEach(t=>$(t+"Tab")?.classList.remove("show"));
      $(tab+"Tab")?.classList.add("show");
      document.querySelectorAll(".tabbtn").forEach(b=> b.classList.toggle("active", b.dataset.tab===tab));
      if(tab==="progress") renderMeasurements();
      if(tab==="strength") renderStrengthHistory(), loadCustomExercises();
      if(tab==="cardio") renderCardioTable();
      if(tab==="meals") loadMealsPlan();
      if(tab==="profile") renderProfile();
    }
    document.querySelectorAll(".tabbtn").forEach(b=> b.addEventListener("click", ()=> switchTab(b.dataset.tab)));

    /* ===========================
       STATE
    =========================== */
    const state = {
      user:null,
      sessionToken: localStorage.getItem("hnt_session") || null,
      stepsToday:0,
      strengthActive:null,
      cardioStart:null,
      quotes:[
        "Discipline beats motivation.",
        "Small wins stack big results.",
        "Form first. Weight later.",
        "Consistency is undefeated.",
        "You don‚Äôt find time ‚Äî you make it."
      ],
      quoteIdx:0,
      typing:{el:null, text:"", i:0, dir:1}
    };

    /* ===========================
       AUTH (simple Firestore-based)
    =========================== */
    $("toSignup").onclick = ()=> show("signupView");
    $("toForgot").onclick = ()=> show("forgotView");
    $("toAdminLogin").onclick = ()=> show("adminLoginView");
    $("backToLogin1").onclick = $("backToLogin2").onclick = $("backToLogin3").onclick = showLogin;

    $("btnSignup").onclick = async ()=>{
      const name = $("signupName").value.trim();
      const email = $("signupEmail").value.trim().toLowerCase();
      const pass = $("signupPassword").value.trim();
      const code = $("signupCode").value.trim().toUpperCase();
      if(!name||!email||!pass||!code) return alert("Fill all fields");

      const codedoc = await getDoc(doc(db,"codes",code));
      if(!codedoc.exists()) return alert("Invalid code");
      const used = codedoc.data().used === true;

      const udoc = await getDoc(doc(db,"users",email));
      if(udoc.exists()) return alert("Email already registered");

      await setDoc(doc(db,"users",email),{
        name, email, pass,
        memberCode: code,
        joinDate: "", // to be set by admin later (you asked admin to set it)
        theme: localStorage.getItem("hnt_theme") || "theme-midnight",
        profile:{ heightCm:"", phone:"" },
        createdAt: serverTimestamp()
      });
      if(!used){ await updateDoc(doc(db,"codes",code),{used:true}); }
      alert("Account created! Please login.");
      showLogin();
    };

    $("btnReset").onclick = async ()=>{
      const email = $("fpEmail").value.trim().toLowerCase();
      const code  = $("fpCode").value.trim().toUpperCase();
      const newPass = $("fpNewPass").value.trim();
      if(!email||!code||!newPass) return alert("Fill all fields");

      const u = await getDoc(doc(db,"users",email));
      if(!u.exists()) return alert("No user found");
      const c = await getDoc(doc(db,"codes",code));
      if(!c.exists()) return alert("Invalid code");

      await updateDoc(doc(db,"users",email), { pass: newPass });
      alert("Password reset successful");
      showLogin();
    };

    $("btnLogin").onclick = async ()=>{
      const name  = $("loginName").value.trim();
      const email = $("loginEmail").value.trim().toLowerCase();
      const pass  = $("loginPassword").value.trim();
      if(!email||!pass) return alert("Enter email and password");

      const d = await getDoc(doc(db,"users",email));
      if(!d.exists()) return alert("No account found");
      const user = d.data();
      if(user.pass !== pass) return alert("Wrong password");
      // Optional: verify name if provided
      if(name && user.name && name.toLowerCase()!==user.name.toLowerCase()){
        return alert("Name doesn't match the account.");
      }
      // session
      const token = Math.random().toString(36).slice(2);
      localStorage.setItem("hnt_session", token);
      state.sessionToken = token;
      state.user = { ...user };
      await afterLogin();
    };

    $("btnAdminLogin").onclick = async ()=>{
      const u = $("adminUser").value.trim();
      const p = $("adminPass").value.trim();
      if(u===ADMIN_USER && p===ADMIN_PASS){
        show("adminPanel");
        buildDietInputs(); // create diet input grid once
        renderMembers();
      }else alert("Wrong admin credentials");
    };

    $("btnAdminLogout").onclick = ()=>{ showLogin(); };
    $("btnAdminBack").onclick   = ()=>{ showLogin(); };

    async function afterLogin(){
      updateWelcome();
      showUserApp();
      await hydrateDashboard();
      await initStepsChart();
      await loadStepsThisWeek();
      startQuoteTyping();
      renderStrengthHistory();
      loadCustomExercises();
      loadMealsPlan();
      renderMeasurements();
      renderProfile();
    }

    function logout(){
      localStorage.removeItem("hnt_session");
      state.sessionToken=null; state.user=null;
      $("taskbar").style.display="none";
      showLogin();
    }
    window.logout = logout;
    function refreshAccount(){ if(state.user){ loginByEmail(state.user.email); } }
    async function loginByEmail(email){
      const d=await getDoc(doc(db,"users",email)); if(!d.exists()) return logout();
      state.user=d.data(); await afterLogin();
    }

    // Auto-restore session (user stays logged in on that device)
    window.addEventListener("load", async ()=>{
      const token = localStorage.getItem("hnt_session");
      if(!token) return; // not logged in
      // best-effort: we need an email hint; store lastEmail in localStorage only as a hint
      const lastEmail = localStorage.getItem("hnt_lastEmail");
      if(lastEmail){
        const d=await getDoc(doc(db,"users",lastEmail));
        if(d.exists()){ state.user=d.data(); await afterLogin(); }
      }else{
        showLogin();
      }
    });

    // When user logs in, remember lastEmail (hint only)
    function rememberEmail(email){ try{ localStorage.setItem("hnt_lastEmail",email); }catch{} }

    /* ===========================
       DASHBOARD + STREAK
    =========================== */
    async function hydrateDashboard(){
      if(!state.user) return;
      rememberEmail(state.user.email);
      // today steps
      const tdoc = await getDoc(doc(db,"users",state.user.email,"dailySteps", todayKey()));
      const steps = tdoc.exists()? (tdoc.data().steps||0) : 0;
      setText("stepsToday", steps);
      state.stepsToday = steps;
      // kcal/time est (rough)
      setText("caloriesToday", Math.round(steps*0.04));
      setText("timeToday", Math.round(steps/110));
      // sessions
      const sSnap = await getDocs(collection(db,"users",state.user.email,"sessions"));
      setText("totalSessions", sSnap.size || 0);
      let lastType = "‚Äî"; let lastTime=0;
      sSnap.forEach(d=>{ const s=d.data(); if(s.createdAt?.seconds>lastTime){ lastTime=s.createdAt.seconds; lastType=s.type; }});
      setText("lastSessionType", lastType);
      // streak
      const streak = await calcStreak();
      setText("streakDays", streak);
    }

    async function calcStreak(){
      const arr=[]; const now=new Date();
      for(let i=0;i<30;i++){
        const d=new Date(now); d.setDate(now.getDate()-i);
        const k=keyFromDate(d);
        const snap=await getDoc(doc(db,"users",state.user.email,"dailySteps",k));
        const v=snap.exists()? (snap.data().steps||0):0;
        arr.push(v>0?1:0);
      }
      let streak=0;
      for(const v of arr){ if(v===1) streak++; else break; }
      return streak;
    }

    function setText(id,v){ const el=$(id); if(el) el.textContent=v; }

    /* ===========================
       QUOTE TYPING + NAME (no fading)
    =========================== */
    function startQuoteTyping(){
      state.typing.el = $("quoteLine");
      nextQuote();
    }
    function nextQuote(){
      state.typing.text = state.quotes[state.quoteIdx%state.quotes.length];
      state.quoteIdx++;
      typeLoop(0,1);
    }
    function typeLoop(i,dir){
      const el = state.typing.el; if(!el) return;
      const full=state.typing.text;
      if(dir>0 && i<=full.length){
        el.textContent = full.slice(0,i);
        setTimeout(()=>typeLoop(i+1,1), 40);
      }else if(dir<0 && i>=0){
        el.textContent = full.slice(0,i);
        setTimeout(()=>typeLoop(i-1,-1), 20);
      }else{
        // pause then reverse direction
        const nextDir = dir>0 ? -1 : 1;
        if(nextDir<0){ setTimeout(()=>typeLoop(full.length-1,-1), 900); }
        else { setTimeout(nextQuote, 600); }
      }
    }

    /* ===========================
       TASKBAR NAV
    =========================== */
    window.switchTab = switchTab;

    /* ===========================
       STEP COUNTER (real motion + fallback)
    =========================== */
    let stepTimer=null, lastMag=0, lastStepTime=0, stepCount=0;
    let stepsChart=null;

    async function startStepCounter(){
      if(!state.user) return alert("Login first");
      // ask permission for iOS
      if(typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function"){
        try{
          const res = await DeviceMotionEvent.requestPermission();
          if(res!=="granted") throw new Error("Motion permission denied");
        }catch(e){
          $("sensorStatus").textContent="Sensor: permission denied ‚Äî use fallback tap";
          return;
        }
      }
      $("sensorStatus").textContent="Sensor: active";
      window.addEventListener("devicemotion", motionHandler);
      if(!stepTimer){
        stepTimer = setInterval(persistStepBuffer, 5000);
      }
    }
    function stopStepCounter(){
      window.removeEventListener("devicemotion", motionHandler);
      clearInterval(stepTimer); stepTimer=null;
      $("sensorStatus").textContent="Sensor: stopped";
      persistStepBuffer();
    }
    function stepTap(){ // fallback for desktop
      stepCount++;
      state.stepsToday++;
      setText("stepCount", stepCount);
      setText("stepsToday", state.stepsToday);
      updateStepsChartPoint();
    }
    function calibrateSteps(){
      lastMag=0; lastStepTime=0; $("sensorStatus").textContent="Sensor: calibrated";
    }
    function motionHandler(e){
      const sens = parseFloat($("stepSensitivity").value||"1.12"); // threshold
      const cooldown = parseInt($("stepCooldown").value||"220",10);
      const a = e.accelerationIncludingGravity || e.acceleration || {x:0,y:0,z:0};
      const mag = Math.sqrt((a.x||0)**2 + (a.y||0)**2 + (a.z||0)**2);
      const now = Date.now();
      // simple peak detect
      if(lastMag>0){
        if(mag/Math.max(0.01,lastMag) > sens && (now-lastStepTime)>cooldown){
          stepCount++; state.stepsToday++;
          setText("stepCount", stepCount);
          setText("stepsToday", state.stepsToday);
          updateStepsChartPoint();
          lastStepTime=now;
        }
      }
      lastMag=mag;
    }
    async function persistStepBuffer(){
      if(!state.user) return;
      const ref=doc(db,"users",state.user.email,"dailySteps",todayKey());
      const snap=await getDoc(ref);
      const prev=snap.exists()? (snap.data().steps||0) : 0;
      await setDoc(ref,{steps: Math.max(prev, state.stepsToday), updatedAt: serverTimestamp()});
    }

    function todayKey(){ return keyFromDate(new Date()); }
    function keyFromDate(d){
      const y=d.getFullYear(), m=("0"+(d.getMonth()+1)).slice(-2), day=("0"+d.getDate()).slice(-2);
      return `${y}-${m}-${day}`;
    }

    // Steps chart
    async function initStepsChart(){
      const ctx=$("stepsChart")?.getContext("2d"); if(!ctx) return;
      stepsChart?.destroy?.();
      stepsChart=new Chart(ctx,{
        type:"line",
        data:{labels:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"], datasets:[{label:"Steps", data:[0,0,0,0,0,0,0]}]},
        options:{responsive:true,tension:.3}
      });
      stepCount=0; setText("stepCount", 0);
    }
    function weekdayIndex(d){ return (d.getDay()+6)%7; } // Mon=0..Sun=6
    function updateStepsChartPoint(){
      if(!stepsChart) return;
      const idx=weekdayIndex(new Date());
      stepsChart.data.datasets[0].data[idx]=state.stepsToday;
      stepsChart.update();
    }
    async function loadStepsThisWeek(){
      if(!state.user||!stepsChart) return;
      const arr=[0,0,0,0,0,0,0];
      const now=new Date();
      for(let i=0;i<7;i++){
        const d=new Date(now); d.setDate(now.getDate() - ((6-i)));
        const snap=await getDoc(doc(db,"users",state.user.email,"dailySteps",keyFromDate(d)));
        const steps=snap.exists()? (snap.data().steps||0):0;
        arr[i]=steps;
      }
      stepsChart.data.datasets[0].data=arr;
      stepsChart.update();
      const t=arr[weekdayIndex(new Date())];
      state.stepsToday=t; stepCount=0;
      setText("stepCount", stepCount);
      setText("stepsToday", t);
    }

    window.startStepCounter=startStepCounter;
    window.stopStepCounter=stopStepCounter;
    window.calibrateSteps=calibrateSteps;
    window.stepTap=stepTap;

    /* ===========================
       CARDIO SESSIONS
    =========================== */
    function startCardio(type){
      if(!state.user) return alert("Login first");
      state.cardioStart=new Date();
      $("activeWorkout").innerHTML=`Active: <b>${type}</b> ‚Äî tracking...`;
      $("lastSessionType").textContent=type;
    }
    async function stopCardio(){
      if(!state.user || !state.cardioStart) return;
      const ended=new Date();
      const durSec=Math.max(1, Math.floor((ended - state.cardioStart)/1000));
      const type=$("lastSessionType").textContent || "Cardio";
      const kcal = Math.round(durSec/60 * (type==="Cycling" ? 7 : type==="Cross Trainer" ? 8 : 6));
      await addDoc(collection(db,"users",state.user.email,"sessions"),{
        type, durationSec:durSec, kcal,
        startedAt: state.cardioStart.toISOString(),
        endedAt: ended.toISOString(),
        createdAt: serverTimestamp()
      });
      state.cardioStart=null;
      $("activeWorkout").innerHTML="";
      alert(`${type}: ${Math.round(durSec/60)} min, ~${kcal} kcal saved`);
      renderCardioTable();
      hydrateDashboard();
    }
    window.startCardio=startCardio;
    window.stopCardio=stopCardio;

    async function renderCardioTable(){
      if(!state.user) return;
      const tbody=$("cardioTable").querySelector("tbody"); tbody.innerHTML="";
      const snap=await getDocs(collection(db,"users",state.user.email,"sessions"));
      const rows=[];
      snap.forEach(d=>{
        const s=d.data();
        if(["Treadmill","Cycling","Cross Trainer","Cardio"].includes(s.type)){
          rows.push(`<tr><td>${(s.startedAt||"").slice(0,16).replace("T"," ")}</td><td>${s.type}</td><td>${Math.round((s.durationSec||0)/60)}m</td><td>${s.kcal||0}</td></tr>`);
        }
      });
      rows.sort().reverse();
      tbody.innerHTML=rows.join("") || `<tr><td colspan="4">No cardio yet</td></tr>`;
    }

    /* ===========================
       STRENGTH SESSIONS
    =========================== */
    function startStrength(template){
      if(!state.user) return alert("Login first");
      state.strengthActive = { template, startedAt:new Date(), notes:"", sets:[] };
      $("strengthActive").innerHTML = renderStrengthActive();
    }
    function renderStrengthActive(){
      const s=state.strengthActive;
      if(!s) return "";
      return `
        <div class="card">
          <h3>Active Strength ‚Äî ${s.template}</h3>
          <div class="grid cols-3">
            <input id="setName" class="input" placeholder="Exercise (e.g., Bench)">
            <input id="setReps" class="input" type="number" placeholder="Reps">
            <input id="setWeight" class="input" type="number" step="0.5" placeholder="Weight (kg)">
          </div>
          <div class="grid cols-2" style="margin-top:6px">
            <button class="btn ghost" onclick="addSet()">Add Set</button>
            <button class="btn" onclick="finishStrength()">Finish & Save</button>
          </div>
          <div id="setList" style="margin-top:8px">${s.sets.map((x,i)=>`#${i+1} ${x.name} ‚Äî ${x.reps}√ó${x.weight}kg`).join("<br>")}</div>
        </div>
      `;
    }
    function addSet(){
      const name=$("setName").value.trim(); const reps=parseInt($("setReps").value,10)||0; const weight=parseFloat($("setWeight").value)||0;
      if(!name||!reps||!weight) return alert("Fill all set fields");
      state.strengthActive.sets.push({name,reps,weight});
      $("strengthActive").innerHTML = renderStrengthActive();
    }
    async function finishStrength(){
      const s=state.strengthActive; if(!s||!state.user) return;
      const ended=new Date();
      const durSec=Math.max(1, Math.floor((ended - s.startedAt)/1000));
      await addDoc(collection(db,"users",state.user.email,"sessions"),{
        type:"Strength-"+s.template, durationSec:durSec, kcal: Math.round(durSec/60*5),
        startedAt: s.startedAt.toISOString(), endedAt: ended.toISOString(),
        sets: s.sets, createdAt: serverTimestamp()
      });
      state.strengthActive=null; $("strengthActive").innerHTML="";
      alert("Strength session saved"); renderStrengthHistory(); hydrateDashboard();
    }
    window.startStrength=startStrength; window.addSet=addSet; window.finishStrength=finishStrength;

    async function renderStrengthHistory(){
      if(!state.user) return;
      const tbody=$("strengthTable").querySelector("tbody"); tbody.innerHTML="";
      const snap=await getDocs(collection(db,"users",state.user.email,"sessions"));
      const rows=[];
      snap.forEach(d=>{
        const s=d.data();
        if((s.type||"").startsWith("Strength-")){
          rows.push(`<tr><td>${(s.startedAt||"").slice(0,16).replace("T"," ")}</td><td>${s.type.replace("Strength-","")}</td><td>${(s.sets||[]).length} sets</td></tr>`);
        }
      });
      rows.sort().reverse();
      tbody.innerHTML=rows.join("") || `<tr><td colspan="3">No strength yet</td></tr>`;
    }

    // Custom exercises (member)
    async function addCustomExercise(){
      if(!state.user) return alert("Login first");
      const name=$("ceName").value.trim(); const target=$("ceTarget").value.trim();
      if(!name||!target) return alert("Fill both fields");
      await addDoc(collection(db,"users",state.user.email,"customExercises"),{ name,target, createdAt:serverTimestamp() });
      $("ceName").value=""; $("ceTarget").value="";
      await loadCustomExercises();
    }
    async function loadCustomExercises(){
      if(!state.user) return;
      const box=$("customExerciseList"); const snap=await getDocs(collection(db,"users",state.user.email,"customExercises"));
      const items=[]; snap.forEach(d=>{ const x=d.data(); items.push(`<span style="display:inline-block;margin:4px 6px;padding:6px 10px;border:1px solid var(--ring);border-radius:10px;">${x.name} ‚Äî <small>${x.target}</small></span>`); });
      box.innerHTML=items.join("")||"<p>No custom exercises yet</p>";
    }

    /* ===========================
       MEALS (weekly plan by admin)
    =========================== */
    const days=["mon","tue","wed","thu","fri","sat","sun"];
    const dayLabel={mon:"Mon",tue:"Tue",wed:"Wed",thu:"Thu",fri:"Fri",sat:"Sat",sun:"Sun"};

    async function loadMealsPlan(){
      if(!state.user) return;
      const ref=doc(db,"users",state.user.email,"meals","weekPlan");
      const snap=await getDoc(ref);
      const plan=snap.exists()? snap.data(): null;
      const tb=$("mealsTable").querySelector("tbody"); tb.innerHTML="";
      days.forEach(d=>{
        const row=plan && plan[d] ? plan[d] : {m:"‚Äî",a:"‚Äî",e:"‚Äî"};
        tb.innerHTML += `<tr><td><b>${dayLabel[d]}</b></td><td>${row.m||"‚Äî"}</td><td>${row.a||"‚Äî"}</td><td>${row.e||"‚Äî"}</td></tr>`;
      });
    }

    // Admin diet planner UI
    function buildDietInputs(){
      const grid=$("dietGrid"); grid.innerHTML="";
      days.forEach(d=>{
        grid.innerHTML += `
          <div class="card">
            <h4>${dayLabel[d]}</h4>
            <input class="input" id="diet_${d}_m" placeholder="Morning">
            <input class="input" id="diet_${d}_a" placeholder="Afternoon" style="margin-top:6px">
            <input class="input" id="diet_${d}_e" placeholder="Evening" style="margin-top:6px">
          </div>
        `;
      });
    }

    /* ===========================
       PROGRESS (measurements)
    =========================== */
    let measureChart=null;
    async function addMeasurement(){
      if(!state.user) return alert("Login first");
      const w=parseFloat($("mWeight").value)||0, bf=parseFloat($("mBF").value)||0, ch=parseFloat($("mChest").value)||0, wa=parseFloat($("mWaist").value)||0;
      if(!w&&!bf&&!ch&&!wa) return alert("Enter at least one value");
      await addDoc(collection(db,"users",state.user.email,"measurements"),{
        dt: new Date().toISOString(),
        w,bf,ch,wa, createdAt: serverTimestamp()
      });
      ["mWeight","mBF","mChest","mWaist"].forEach(id=>$(id).value="");
      await renderMeasurements();
    }

    async function renderMeasurements(){
      if(!state.user) return;
      const tbody=$("measureTable").querySelector("tbody"); tbody.innerHTML="";
      const snap=await getDocs(collection(db,"users",state.user.email,"measurements"));
      const rows=[], data=[];
      snap.forEach(d=>{
        const m=d.data(); rows.push(m); data.push({x:m.dt, w:m.w||0, bf:m.bf||0, ch:m.ch||0, wa:m.wa||0});
      });
      rows.sort((a,b)=> (a.dt||"").localeCompare(b.dt||""));
      if(rows.length===0){ tbody.innerHTML=`<tr><td colspan="5">No measurements yet</td></tr>`; }
      else{
        tbody.innerHTML=rows.map(m=>`<tr><td>${(m.dt||"").slice(0,10)}</td><td>${m.w||"-"}</td><td>${m.bf||"-"}</td><td>${m.ch||"-"}</td><td>${m.wa||"-"}</td></tr>`).join("");
      }
      drawMeasureChart(data);
    }

    function drawMeasureChart(data){
      const ctx=$("measureChart")?.getContext("2d"); if(!ctx) return;
      measureChart?.destroy?.();
      const labels=data.map(d=>d.x.slice(0,10));
      measureChart=new Chart(ctx,{
        type:"line",
        data:{
          labels,
          datasets:[
            {label:"Weight (kg)", data:data.map(d=>d.w)},
            {label:"Body Fat %",  data:data.map(d=>d.bf)},
            {label:"Chest (cm)",  data:data.map(d=>d.ch)},
            {label:"Waist (cm)",  data:data.map(d=>d.wa)}
          ]
        },
        options:{responsive:true,tension:.3}
      });
    }

    window.addMeasurement=addMeasurement;

    /* ===========================
       PROFILE
    =========================== */
    function renderProfile(){
      if(!state.user) return;
      const u=state.user;
      $("profileInfo").innerHTML = `
        <table>
          <tr><th>Name</th><td>${u.name||"-"}</td></tr>
          <tr><th>Email</th><td>${u.email||"-"}</td></tr>
          <tr><th>Member Code</th><td>${u.memberCode||"-"}</td></tr>
          <tr><th>Join Date</th><td>${u.joinDate||"(set by admin)"}</td></tr>
          <tr><th>Theme</th><td>${u.theme||"(default)"}</td></tr>
        </table>
      `;
      $("profileTheme").value = u.theme || "";
    }
    async function applyProfileTheme(){
      if(!state.user) return;
      const th=$("profileTheme").value;
      await updateDoc(doc(db,"users",state.user.email),{ theme: th });
      state.user.theme=th;
      themeSelect.value=th; themeSelect.dispatchEvent(new Event("change"));
      alert("Theme saved to profile");
    }
    window.applyProfileTheme=applyProfileTheme;

    /* ===========================
       ADMIN ‚Äî MEMBERS & DIET
    =========================== */
    let _adminSelected=null, _adminSelectedData=null, _lastGeneratedCode="";
    $("btnGenCode").onclick = async ()=>{
      const name=$("memberNameInput").value.trim();
      if(!name) return alert("Enter member name");
      const code=(name.split(" ")[0]||name).toUpperCase()+"-"+Math.floor(10000+Math.random()*90000);
      await setDoc(doc(db,"codes",code),{name,used:false,createdAt:serverTimestamp()});
      _lastGeneratedCode=code;
      $("lastCode").textContent = `Generated Code: ${code}`;
      try{ await navigator.clipboard.writeText(code); }catch{}
      alert("Code generated");
    };
    $("btnCopyCode").onclick = async ()=>{
      if(!_lastGeneratedCode){ alert("Nothing to copy yet"); return; }
      try{ await navigator.clipboard.writeText(_lastGeneratedCode); alert("Copied!"); }catch{ alert("Copy failed"); }
    };

    async function renderMembers(){
      const snap=await getDocs(collection(db,"users"));
      const list=$("membersList");
      if(snap.empty){ list.innerHTML="<p>No members yet</p>"; return; }
      list.innerHTML = Array.from(snap.docs).map(d=>{
        const u=d.data();
        return `
          <div class="card" style="margin:8px 0">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
              <div><b>${u.name||"-"}</b> ‚Ä¢ ${u.email}</div>
              <button class="btn ghost" onclick="adminEdit('${d.id}')">Manage</button>
            </div>
          </div>
        `;
      }).join("");
    }
    window.adminEdit = async function(email){
      _adminSelected=email;
      const userDoc=await getDoc(doc(db,"users",email));
      if(!userDoc.exists()) return alert("User not found");
      _adminSelectedData=userDoc.data();
      $("editMemberCard").style.display="block";
      $("editMemberTitle").textContent=`Edit: ${_adminSelectedData.name||email}`;
      $("editJoinDate").value = (_adminSelectedData.joinDate && _adminSelectedData.joinDate.length===10) ? _adminSelectedData.joinDate : "";
      $("editMemberCode").value = _adminSelectedData.memberCode || "";
      // load diet
      const planSnap=await getDoc(doc(db,"users",email,"meals","weekPlan"));
      const plan=planSnap.exists()? planSnap.data() : null;
      days.forEach(d=>{
        $("diet_"+d+"_m").value = plan?.[d]?.m || "";
        $("diet_"+d+"_a").value = plan?.[d]?.a || "";
        $("diet_"+d+"_e").value = plan?.[d]?.e || "";
      });
      // tables
      await adminTables(email);
    };

    $("btnSaveMeta").onclick = async ()=>{
      if(!_adminSelected) return;
      const join = $("editJoinDate").value || "";
      const code = $("editMemberCode").value.trim() || "";
      await updateDoc(doc(db,"users",_adminSelected),{ joinDate:join, memberCode:code });
      alert("Meta saved");
    };

    $("btnSaveDiet").onclick = async ()=>{
      if(!_adminSelected) return;
      const plan={};
      days.forEach(d=>{
        plan[d]={ m:$("diet_"+d+"_m").value.trim(), a:$("diet_"+d+"_a").value.trim(), e:$("diet_"+d+"_e").value.trim() };
      });
      await setDoc(doc(db,"users",_adminSelected,"meals","weekPlan"), plan);
      alert("Diet plan saved");
      if(state.user && state.user.email===_adminSelected){ loadMealsPlan(); }
    };

    $("btnAdmAddEx").onclick = async ()=>{
      if(!_adminSelected) return alert("Select a member first");
      const n=$("admExName").value.trim(), t=$("admExTarget").value.trim();
      if(!n||!t) return alert("Fill both fields");
      await addDoc(collection(db,"users",_adminSelected,"customExercises"),{ name:n, target:t, createdAt:serverTimestamp() });
      $("admExName").value=""; $("admExTarget").value="";
      alert("Exercise added to member");
      if(state.user && state.user.email===_adminSelected){ loadCustomExercises(); }
    };

    async function adminTables(email){
      const sBody=$("adminSessionsTable").querySelector("tbody");
      const mBody=$("adminMeasuresTable").querySelector("tbody");
      sBody.innerHTML=mBody.innerHTML="";
      const sSnap=await getDocs(collection(db,"users",email,"sessions"));
      const rows=[];
      sSnap.forEach(d=>{
        const s=d.data();
        rows.push(`<tr><td>${(s.startedAt||"").slice(0,16).replace("T"," ")}</td><td>${s.type}</td><td>${Math.round((s.durationSec||0)/60)}m</td><td>${s.kcal||0}</td></tr>`);
      });
      rows.sort().reverse();
      sBody.innerHTML=rows.join("")||`<tr><td colspan="4">No sessions</td></tr>`;

      const mSnap=await getDocs(collection(db,"users",email,"measurements"));
      const mrows=[];
      mSnap.forEach(d=>{
        const m=d.data();
        mrows.push(`<tr><td>${(m.dt||"").slice(0,10)}</td><td>${m.w||"-"}</td><td>${m.bf||"-"}</td><td>${m.ch||"-"}</td><td>${m.wa||"-"}</td></tr>`);
      });
      mrows.sort().reverse();
      mBody.innerHTML=mrows.join("")||`<tr><td colspan="5">No measurements</td></tr>`;
    }

    /* ===========================
       LOGIN LINKS WIRING
    =========================== */
    // already wired above; ensure no missing listeners:
    // btnLogin, toSignup, toForgot, toAdminLogin, backToLogin1/2/3, btnAdminLogin ‚Äî all set.

  </script>
</body>
</html>


